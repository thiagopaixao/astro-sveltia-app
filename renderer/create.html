<!DOCTYPE html>
<html class="dark" lang="pt-BR"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Documental - Criando Espaço de Trabalho</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
        .creative-loader {
            width: 50px;
            height: 50px;
            position: relative;
        }
        .creative-loader::before, .creative-loader::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 6px solid transparent;
            border-top-color: #22c55e;
            animation: spin-creative 1.5s ease-in-out infinite;
        }
        .creative-loader::after {
            border-top-color: #3b82f6;
            animation-delay: 0.3s;
            animation-direction: reverse;
        }
        @keyframes spin-creative {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(0.8); }
            100% { transform: rotate(360deg) scale(1); }
        }
        .step-icon-active {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#22c55e",
                        "background-light": "#f3f4f6",
                        "background-dark": "#111827",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1f2937",
                        "text-light": "#111827",
                        "text-dark": "#f9fafb",
                        "muted-light": "#6b7280",
                        "muted-dark": "#9ca3af",
                    },
                },
            },
        };
    </script>
<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="script.js" defer></script>
</head>
<body class="bg-background-dark text-text-dark antialiased">
<div class="flex flex-col h-screen" x-data="{
        projectId: null,
        projectPath: '',
        githubUrl: '',
        repoFolderName: '',
        activeStepId: 1,
        processFinished: false,
        processFailed: false,
        processPaused: false,
        steps: [
            { id: 1, title: 'Clonando repositório git do projeto...', status: 'pending', log: '', expanded: false },
            { id: 2, title: 'Verificando e garantindo branch preview...', status: 'pending', log: '', expanded: false },
            { id: 3, title: 'Instalando dependências...', status: 'pending', log: '', expanded: false },
            { id: 4, title: 'Construindo o projeto...', status: 'pending', log: '', expanded: false },
            { id: 5, title: 'Executando servidor do modo dev...', status: 'pending', log: '', expanded: false }
        ],
        get allStepsSuccess() {
            return this.steps.every(s => s.status === 'success');
        },
        get anyStepFailed() {
            return this.steps.some(s => s.status === 'failure');
        },
        init() {
            // Watch for process pause
            this.$watch('processPaused', (value) => {
                if (value) {
                    console.log('Process paused');
                }
            });
            
            this.projectId = sessionStorage.getItem('currentProjectId');
            this.isReopenMode = sessionStorage.getItem('reopenMode') === 'true';
            this.isExistingGitRepo = sessionStorage.getItem('isExistingGitRepo') === 'true';
            this.isEmptyFolder = sessionStorage.getItem('isEmptyFolder') === 'true';
            
            if (!this.projectId) {
                console.error('No project ID found in session storage.');
                this.processFailed = true;
                return;
            }

            const savedState = JSON.parse(sessionStorage.getItem(`projectCreationState-${this.projectId}`));
            if (savedState) {
                Object.assign(this.$data, savedState);
            } else if (this.isReopenMode) {
                // For reopen mode, mark first 3 steps as completed
                this.steps[0].status = 'success';
                this.steps[1].status = 'success';
                this.steps[2].status = 'success';
                this.steps[3].status = 'active';
                this.activeStepId = 4;
            } else if (this.isExistingGitRepo) {
                // For existing git repo, skip git clone step
                this.steps[0].status = 'success';
                this.steps[0].title = 'Repositório git encontrado (clone ignorado)...';
                this.steps[1].status = 'active';
                this.activeStepId = 2;
            } else if (this.isEmptyFolder) {
                // For empty folder, clone directly into the folder
                this.steps[0].title = 'Clonando repositório para pasta selecionada...';
                this.steps[0].status = 'active';
                this.activeStepId = 1;
            } else {
                this.steps[0].status = 'active';
            }

            this.$watch('steps', (newSteps) => {
                sessionStorage.setItem(`projectCreationState-${this.projectId}`, JSON.stringify({
                    projectId: this.projectId,
                    projectPath: this.projectPath,
                    githubUrl: this.githubUrl,
                    repoFolderName: this.repoFolderName,
                    activeStepId: this.activeStepId,
                    processFinished: this.processFinished,
                    processFailed: this.processFailed,
                    steps: newSteps
                }));
            }, { deep: true });

            // Removed activeStepId watcher to allow expanding completed steps

            window.electronAPI.onCommandOutput((output) => {
                const activeStepIndex = this.steps.findIndex(s => s.status === 'active');
                if (activeStepIndex !== -1) {
                    this.steps[activeStepIndex].log += output;
                }
            });

            window.electronAPI.onCommandStatus((status) => {
                const activeStepIndex = this.steps.findIndex(s => s.status === 'active');
                if (activeStepIndex !== -1) {
                    if (status === 'success') {
                        this.steps[activeStepIndex].status = 'success';
                        if (activeStepIndex + 1 < this.steps.length) {
                            this.steps[activeStepIndex + 1].status = 'active';
                            this.activeStepId = this.steps[activeStepIndex + 1].id;
                        } else {
                            // If it's the last step and it succeeded, mark process as finished
                            this.processFinished = true;
                        }
                    } else if (status === 'failure') {
                        this.steps[activeStepIndex].status = 'failure';
                        this.processFinished = true;
                        this.processFailed = true;
                    } else if (status === 'cancelled') {
                        this.processFinished = true;
                        this.processFailed = true; // Mark as failed for UI purposes
                        this.steps[activeStepIndex].log += '\nProcesso cancelado pelo usuário.';
                    }
                }
                // Special handling for the last step (npm run dev)
                // If the last step is active, consider the process finished from a UI perspective
                // to allow the user to proceed, as dev servers typically run indefinitely.
                if (this.steps[this.steps.length - 1].status === 'active') {
                    this.processFinished = true;
                }
            });

            window.electronAPI.onDevServerUrl((url) => {
                sessionStorage.setItem('devServerUrl', url);
                console.log('Dev server URL saved to session storage:', url);
            });

            window.electronAPI.onServerOutput((output) => {
                // Store server output in sessionStorage for persistence
                const currentServerOutput = sessionStorage.getItem('serverOutput') || '';
                sessionStorage.setItem('serverOutput', currentServerOutput + output);
                
                // Also add to the active step log if there's an active step
                const activeStepIndex = this.steps.findIndex(s => s.status === 'active');
                if (activeStepIndex !== -1) {
                    this.steps[activeStepIndex].log += output;
                }
            });

            this.startCreationProcess();
            
            // Setup modal event listeners
            this.setupModalListeners();
        },
        
        setupModalListeners() {
            const modal = document.getElementById('cancel-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const confirmReturnBtn = document.getElementById('confirm-return-btn');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', () => {
                    this.confirmCancelAndDelete();
                });
            }
            
            if (confirmReturnBtn) {
                confirmReturnBtn.addEventListener('click', () => {
                    this.confirmCancelAndReturn();
                });
            }
            
            if (cancelModalBtn) {
                cancelModalBtn.addEventListener('click', () => {
                    this.closeCancelModal();
                });
            }
            
            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeCancelModal();
                    }
                });
            }
        },
        async startCreationProcess() {
            try {
                const projectDetails = await window.electronAPI.getProjectDetails(this.projectId);
                this.projectPath = projectDetails.projectPath;
                this.githubUrl = projectDetails.githubUrl;
                this.repoFolderName = projectDetails.repoFolderName; // This might be null initially

                // If process was not finished, restart it
                if (!this.processFinished) {
                    if (this.isReopenMode && this.repoFolderName) {
                        // For reopen mode, only run build and dev server
                        await window.electronAPI.reopenProject(this.projectId, this.projectPath, this.githubUrl, this.repoFolderName);
                    } else {
                        // For new projects, run full creation process
                        await window.electronAPI.startProjectCreation(this.projectId, this.projectPath, this.githubUrl, this.isExistingGitRepo || false, this.isEmptyFolder || false);
                    }
                }
            } catch (error) {
                console.error('Error fetching project details or starting creation:', error);
                this.processFailed = true;
                this.processFinished = true;
                const activeStepIndex = this.steps.findIndex(s => s.status === 'active');
                if (activeStepIndex !== -1) {
                    this.steps[activeStepIndex].log += `\nErro: ${error.message || error}`;
                    this.steps[activeStepIndex].status = 'failure';
                }
            }
        },
        async cancelProcess() {
            // Pause the process and show confirmation modal
            console.log('cancelProcess called');
            this.processPaused = true;
            
            // Show modal using vanilla JavaScript
            const modal = document.getElementById('cancel-modal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Modal shown');
            }
        },
        
        async confirmCancelAndDelete() {
            try {
                // Cancel the process and delete project
                if (this.projectId && this.projectPath) {
                    await window.electronAPI.cancelProjectCreation(this.projectId, this.projectPath, this.repoFolderName);
                    // Also remove from database
                    await window.electronAPI.removeProject(this.projectId);
                }
                
                // Clear session storage
                sessionStorage.removeItem(`projectCreationState-${this.projectId}`);
                sessionStorage.removeItem('currentProjectId');
                sessionStorage.removeItem('reopenMode');
                
                // Navigate to index
                window.electronAPI.navigateTo('index.html');
            } catch (error) {
                console.error('Error canceling and deleting project:', error);
                alert('Erro ao cancelar e excluir projeto: ' + error);
            }
        },
        
        async confirmCancelAndReturn() {
            try {
                // Just cancel the process without deleting
                if (this.projectId && this.projectPath) {
                    await window.electronAPI.cancelProjectCreation(this.projectId, this.projectPath, this.repoFolderName);
                }
                
                // Clear session storage
                sessionStorage.removeItem(`projectCreationState-${this.projectId}`);
                sessionStorage.removeItem('currentProjectId');
                sessionStorage.removeItem('reopenMode');
                
                // Navigate to index
                window.electronAPI.navigateTo('index.html');
            } catch (error) {
                console.error('Error canceling project:', error);
                alert('Erro ao cancelar projeto: ' + error);
            }
        },
        
        closeCancelModal() {
            const modal = document.getElementById('cancel-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            this.processPaused = false;
            // Continue the process
        },
        async retryProcess() {
            this.processFinished = false;
            this.processFailed = false;
            
            if (this.isReopenMode) {
                this.activeStepId = 4;
                this.steps.forEach((step, index) => {
                    if (index < 3) {
                        step.status = 'success';
                        step.log = 'Passo concluído anteriormente.';
                    } else if (index === 3) {
                        step.status = 'active';
                        step.log = '';
                    } else {
                        step.status = 'pending';
                        step.log = '';
                    }
                });
            } else {
                this.activeStepId = 1;
                this.steps.forEach((step, index) => {
                    step.status = index === 0 ? 'active' : 'pending';
                    step.log = '';
                });
            }
            
            sessionStorage.removeItem(`projectCreationState-${this.projectId}`);
            await this.startCreationProcess();
        }
    }">
<div class="flex-1 flex items-center justify-center p-8 overflow-y-auto">
<div class="w-full max-w-2xl">

<div class="text-center mb-8">
<div class="flex items-center justify-center gap-4 mb-3">
<div class="creative-loader"></div>
</div>
<h1 class="text-3xl font-bold text-text-dark" x-text="isReopenMode ? 'Reabrindo Espaço de Trabalho' : 'Criando Espaço de Trabalho'"></h1>
<p class="text-muted-dark text-base mt-1" x-text="isReopenMode ? 'Aguarde enquanto preparamos seu projeto novamente.' : 'Aguarde enquanto preparamos tudo para você.'"></p>
</div>
<div class="bg-surface-dark rounded-lg p-4 space-y-2">
<template :key="step.id" x-for="(step, index) in steps">
<div :class="{ 'opacity-60': step.status !== 'active' && step.status !== 'failure' && step.status !== 'success'}" class="bg-gray-900/50 rounded-lg text-sm">
<div :class="{'cursor-pointer': step.status !== 'active'}" @click="step.expanded = !step.expanded" class="flex items-center justify-between p-3">
<div class="flex items-center gap-3">
<div class="flex items-center justify-center w-6 h-6">
<template x-if="step.status === 'active'">
<span class="material-symbols-outlined text-primary text-xl step-icon-active">autorenew</span>
</template>
<template x-if="step.status === 'success'">
<span class="material-symbols-outlined text-green-500 text-xl">check_circle</span>
</template>
<template x-if="step.status === 'failure'">
<span class="material-symbols-outlined text-red-500 text-xl">error</span>
</template>
<template x-if="step.status === 'pending'">
<div class="w-4 h-4 border-2 border-gray-600 rounded-full"></div>
</template>
</div>
<span :class="{ 'text-muted-dark': step.status === 'pending', 'text-text-dark font-semibold': step.status === 'success', 'text-text-dark': step.status === 'active', 'text-red-400': step.status === 'failure' }" class="font-medium" x-text="step.title"></span>
</div>
<span :class="{ 'rotate-180': step.expanded }" class="material-symbols-outlined transition-transform">expand_more</span>
</div>
<div x-cloak="" x-show="step.expanded" x-transition:enter="transition ease-out duration-300" x-transition:enter-end="opacity-100 translate-y-0" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:leave="transition ease-in duration-200" x-transition:leave-end="opacity-0 -translate-y-2" x-transition:leave-start="opacity-100 translate-y-0">
<div class="px-3 pb-3">
<div class="bg-gray-900 rounded-md p-3 max-h-40 overflow-y-auto border border-gray-700">
<pre class="text-xs text-muted-dark whitespace-pre-wrap font-mono" x-text="step.log"></pre>
</div>
</div>
</div>
</div>
</template>
</div>
</div>
</div>
<div class="p-4 border-t border-gray-800 bg-surface-dark mt-auto">
<div class="flex justify-end gap-4 max-w-2xl mx-auto">
 <button @click="cancelProcess()" class="bg-red-600 hover:bg-red-500 text-white font-semibold py-2 px-5 rounded-md transition-colors duration-300 text-sm">
                    Cancelar
                </button>
<template x-if="!anyStepFailed">
<button :class="{'!bg-primary !hover:bg-green-500': allStepsSuccess}" :disabled="!allStepsSuccess" @click="allStepsSuccess ? window.electronAPI.navigateTo('main.html') : $event.target.innerText = 'Finalizado!';" class="bg-gray-600 text-white font-semibold py-2 px-5 rounded-md flex items-center gap-2 transition-colors duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed text-sm">
<span x-text="allStepsSuccess ? 'Finalizar' : 'Avançar'"></span>
</button>
</template>
<template x-if="anyStepFailed">
<button :disabled="!processFinished" @click="retryProcess()" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-5 rounded-md flex items-center gap-2 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                        Tentar novamente
                    </button>
</template>
</div>
</div>
</div>

<!-- Modal de confirmação para cancelar -->
<div id="cancel-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" style="display: none;">
    <div class="bg-surface-dark rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <div class="flex items-center gap-3 mb-4">
            <span class="material-symbols-outlined text-yellow-500 text-2xl">warning</span>
            <h3 class="text-lg font-medium text-text-dark">Cancelar Criação do Projeto</h3>
        </div>
        <p class="text-sm text-muted-dark mb-6">O processo de criação está em andamento. Deseja realmente cancelar?</p>
        
        <div class="space-y-3">
            <button id="confirm-delete-btn" 
                    class="w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors duration-200">
                Sim e excluir projeto
            </button>
            <button id="confirm-return-btn" 
                    class="w-full px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-md hover:bg-orange-700 transition-colors duration-200">
                Sim e voltar ao início
            </button>
            <button id="cancel-modal-btn" 
                    class="w-full px-4 py-2 text-sm font-medium text-muted-dark bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200">
                Não e continuar
            </button>
        </div>
    </div>
</div>

</body></html>
